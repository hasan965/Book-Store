{% extends "index.html" %}

{% block content %}
<style>
    * {
        margin: 0;
        padding: 0;
        -webkit-font-smoothing: antialiased;
        -webkit-text-shadow: rgba(0, 0, 0, .01) 0 0 1px;
        text-shadow: rgba(0, 0, 0, .01) 0 0 1px;
    }

    .breadcrumb-item+.breadcrumb-item::before {
        content: ">";
    }

    .breadcrumb {
        display: flex;
        flex-wrap: wrap;
        padding: .1rem 0rem !important;
        margin-bottom: 0rem;
        list-style: none;
        background-color: #ffffff;
        border-radius: .25rem;
    }

    .product_name {
        font-size: 20px;
        font-weight: 400;
        margin-top: 0px;
    }

    .product_price {
        display: inline-block;
        font-size: 30px;
        font-weight: 500;
        margin-top: 9px;
    }

    .product_info {
        color: #4d4d4d;
        display: inline-block;
    }

    .product_description {
        padding-left: 0px;
    }

    .image_selected {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: calc(100% + 15px);
        height: 525px;
        transform: translateX(-15px);
        border: solid 1px #e8e8e8;
        overflow: hidden;
        padding: 15px;
    }

    .qty {
        margin-bottom: 15px;
    }

    .card-img-top {
        height: 200px;
        object-fit: cover;
    }
</style>

<body>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://kit.fontawesome.com/b7cece0517.js" crossorigin="anonymous"></script>
    <br>

    <div class="container">
        <form id="add-to-cart-form" method="post" action="/addToCart">
            {% csrf_token %}
            <div class="product_description">
                <nav>
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item active">Book Details</li>
                    </ol>
                </nav>
                <br>
            </div>

            <div class="row">
                <div class="col-lg-7 order-lg-1 order-1">
                    <div class="image_selected">
                        <img src="{{ book.image.url }}" class="img-fluid" alt="{{ book.p_short_name }}">
                    </div>
                    <div class="mt-3">
                        <h5>{{ t.about_book }}</h5>
                        <p class="text-muted">{{ book.description|default:t.no_description }}</p>
                    </div>
                </div>

                <div class="col-lg-5 order-2">
                    <div class="card sticky-top" style="top:100px;">
                        <div class="card-body">
                            <h4 class="product_name">{{ book.p_short_name }}</h4>
                            <p class="product_price">€ {{ book.price }}</p>
                            <p class="product_info">Seller: <strong>Official Seller</strong></p>
                            <hr>
                            <input type="hidden" name="bookid" value="{{ book.id }}">
                            <div class="mb-2">
                                <label>Quantity</label>
                                <input type="number" name="qty" value="1" min="1" class="form-control">
                            </div>
                            <div class="d-flex gap-2">
                                <button id="add-to-cart-btn" class="btn btn-primary flex-fill">{{ t.add_to_cart|default:'Add to cart' }}</button>
                                <a href="/MakePayment" class="btn btn-outline-success">Buy now</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <br>
    <h3>Suggested Books</h3>
    <div class="row">
{% for sug in suggestions %}
<div class="col-xs-12 col-sm-6 col-md-3 mb-4">
    <div class="card" style="width: 18rem;">
        <img src="{{ sug.image.url }}" class="card-img-top" alt="{{ sug.p_short_name }}">
            <div class="card-body text-center">
            <h6 class="card-title">{{ sug.p_short_name }}</h6>
            <p class="card-text">€ {{ sug.price }}</p>
            <a href="/ViewDetails/{{ sug.id }}" class="btn btn-sm btn-primary">{{ t.view_details|default:'View Details' }}</a>
        </div>
    </div>
</div>
{% endfor %}


    </div>

    <script>
    // Helper to read CSRF token from cookie (Django default)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('add-to-cart-form');
        if (!form) return;
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = document.getElementById('add-to-cart-btn');
            const formData = new FormData(form);

            btn.disabled = true;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = 'Adding...';

            try {
                const res = await fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: formData
                });

                if (!res.ok) throw new Error('Network response was not ok');
                const data = await res.json();
                if (data.success) {
                    // update cart badge in navbar
                    const badge = document.getElementById('cart-badge');
                    if (badge) {
                        badge.textContent = data.cart_count;
                        badge.classList.remove('d-none');
                    } else {
                        const existing = document.querySelector('.position-absolute.badge');
                        if (existing) {
                            existing.textContent = data.cart_count;
                            existing.classList.remove('d-none');
                        }
                    }
                } else {
                    alert(data.message || 'تعذر إضافة المنتج إلى السلة.');
                }

            } catch (err) {
                console.error(err);
                alert('تعذر إضافة المنتج إلى السلة. حاول مرة أخرى.');
            } finally {
                // mark as added visually and keep disabled for a short cooldown to prevent duplicate clicks
                btn.innerHTML = 'Added ✓';
                setTimeout(function(){
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                }, 5000); // 5 seconds cooldown
            }
        });
    });
    </script>

</body>
{% endblock %}
