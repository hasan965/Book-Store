{% extends "index.html" %}
{% load static %}

{% block content %}
<style>
    * {
        margin: 0;
        padding: 0;
        -webkit-font-smoothing: antialiased;
        -webkit-text-shadow: rgba(0, 0, 0, .01) 0 0 1px;
        text-shadow: rgba(0, 0, 0, .01) 0 0 1px
    }

    .breadcrumb-item+.breadcrumb-item::before {
        content: ">"
    }

    .breadcrumb {
        display: -ms-flexbox;
        display: flex;
        -ms-flex-wrap: wrap;
        flex-wrap: wrap;
        padding: .1rem 0rem !important;
        margin-bottom: 0rem;
        list-style: none;
        /* background-color: #ffffff; */
        border-radius: .25rem
    }

    .CartContainer {
        width: 100%;
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 6px 16px rgba(0,0,0,0.06);
        padding: 18px;
    }

    /* modern card style for each cart row */
    .cart-row {
        background: #ffffff;
        border: 1px solid rgba(0,0,0,0.04);
        border-radius: 10px;
        padding: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: box-shadow .15s ease, transform .12s ease;
    }
    .cart-row:hover { box-shadow: 0 10px 30px rgba(16,50,100,0.06); transform: translateY(-2px); }
    .cart-row .image-box img { border-radius: 6px; }
    .cart-row .title { font-size: 18px; margin: 0; font-weight: 700; }
    .cart-row .items { color: #6b7280; font-size: 13px; }
    .qty-controls .btn { min-width: 36px; }
    .unit-price { color: #6b7280; font-size: 13px; }

    .Cart-Items {
        margin: auto;
        width: 90%;
        height: 30%;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .about {
        height: 100%;
        width: 24%;
    }

    .title {
        line-height: 28px;
        font-size: 30px;
        font-family: 'Open Sans';
        font-weight: 700;
        color: #202020;
    }

    .subtitle {
        line-height: 10px;
        font-size: 18px;
        font-family: 'Open Sans';
        font-weight: 600;
        color: #909090;
    }

    .counter {
        width: 15%;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .remove-but {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #d9d9d9;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px;
        font-family: 'Open Sans';
        font-weight: 900;
        color: #202020;
        cursor: pointer;
    }

    .count {
        font-size: 20px;
        font-family: 'Open Sans';
        font-weight: 600;
        color: #202020;
    }

    .prices {
        height: 100%;
        text-align: right;
    }

    .amount {
        padding-top: 20px;
        font-size: 26px;
        font-family: 'Open Sans';
        font-weight: 800;
        color: #202020;
    }

    .save {
        padding-top: 5px;
        font-size: 14px;
        font-family: 'Open Sans';
        font-weight: 600;
        color: #1687d9;
        cursor: pointer;
    }

    .remove {
        padding-top: 5px;
        font-size: 14px;
        font-family: 'Open Sans';
        font-weight: 600;
        color: #E44C4C;
        cursor: pointer;
    }

    .pad {
        margin-top: 5px;
    }

    hr {
        width: 66%;
        float: right;
        margin-right: 5%;
    }

    .checkout {
        position: sticky;
        top: 100px;
        padding: 16px;
        border-radius: 10px;
        background: linear-gradient(180deg,#ffffff,#f8fbff);
        box-shadow: 0 6px 18px rgba(8,70,120,0.06);
    }

    .total {
        width: 100%;
        display: flex;
        justify-content: space-between;
    }

    /* .Subtotal {
        font-size: 22px;
        font-family: 'Open Sans';
        font-weight: 700;
        color: #202020;
    } */

    .items {
        font-size: 15px;
        font-family: 'Open Sans';
        font-weight: 500;
        color: #909090;
        line-height: 10px;
    }

    .total-amount {
        font-size: 34px;
        font-family: 'Open Sans';
        font-weight: 900;
        color: #202020;
    }

    .button {
        margin-top: 10px;
        width: 100%;
        height: 44px;
        border: none;
        background: var(--primary, #ff8a00);
        color: #fff;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 700;
    }
</style>
<script>
    function decrement(myid, formid) {
        const txtqty = document.getElementById(myid);
        if (!txtqty) return;
        if (parseInt(txtqty.value || 0) > 1) {
            txtqty.value = parseInt(txtqty.value) - 1;
            const f = document.getElementById(formid);
            if (f) f.submit();
        }
    }
    function increment(myid, formid) {
        const txtqty = document.getElementById(myid);
        if (!txtqty) return;
        if (parseInt(txtqty.value || 0) < 99) {
            txtqty.value = parseInt(txtqty.value) + 1;
            const f = document.getElementById(formid);
            if (f) f.submit();
        }
    }

    function Remove(myid) {
        const Result = confirm("Are you sure you want to delete this book?");
        if (Result) {
            const myform = document.getElementById(myid);
            if (myform) {
                // set action to remove so view deletes the item
                let actionField = myform.querySelector('input[name="action"]');
                if (!actionField) {
                    actionField = document.createElement('input');
                    actionField.type = 'hidden';
                    actionField.name = 'action';
                    myform.appendChild(actionField);
                }
                actionField.value = 'remove';
                myform.submit();
            }
        }
    }
</script>
</script>

<body>
    <br>
    <div class="container mt-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">{{ t.home|default:'Home' }}</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ t.cart_title|default:'Cart details' }}</li>
            </ol>
        </nav>

    {% if items|length < 1 %}
            <div class="text-center py-5">
                <h3>{{ t.cart_empty|default:'Cart is empty' }} <br>
                    <img width="140" src="{% static 'Empty Cart.jpg' %}" alt="empty"></h3>
            </div>
        {% else %}
        <div class="CartContainer row">
            <div class="col-md-8">
                {% for item in items %}
                        <form method="post" id="myform{{ item.cart_id }}">
                    {% csrf_token %}
                            <input type="hidden" name="bookid" value="{{ item.book_id }}">
                    <div class="cart-row mb-3">
                        <div class="image-box">
                                    <a href="/ViewDetails/{{ item.book_id }}"><img src="{{ item.image_url }}" style="width:110px; height:140px; object-fit:cover;" /></a>
                        </div>
                        <div class="about flex-grow-1">
                                    <a href="/ViewDetails/{{ item.book_id }}" class="text-decoration-none text-dark"><h5 class="title">{{ item.title }}</h5></a>
                                    <div class="items">{{ item.author|default:'' }}</div>
                                    <!-- debug ids: visible for verification -->
                                    <div class="small text-muted">Cart: {{ item.cart_id }} | Book: {{ item.book_id }}</div>
                            <div class="mt-2">
                                        <div class="unit-price small mb-2">{{ 'Unit: €' }} {{ item.unit_price|floatformat:2 }}</div>
                                <div class="d-flex align-items-center gap-2 qty-controls">
                                            <input type="hidden" name="action" value="update" />
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="decrement('qty{{ item.cart_id }}','myform{{ item.cart_id }}')">-</button>
                                            <input type="text" value="{{ item.qty }}" name="qty" id="qty{{ item.cart_id }}" size="1" style="text-align:center; width:52px;">
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="increment('qty{{ item.cart_id }}','myform{{ item.cart_id }}')">+</button>
                                            <button type="button" class="btn btn-link btn-sm text-danger ms-2" onclick="Remove('myform{{ item.cart_id }}')">{{ t.remove|default:'Remove' }}</button>
                                </div>
                            </div>
                        </div>
                        <div class="prices text-end" style="width:220px;">
                                    <div class="amount">€ {{ item.line_total|floatformat:2 }}</div>
                        </div>
                    </div>
                </form>
                <hr />
                {% endfor %}
            </div>

            <div class="col-md-4">
                <div class="checkout">
                    {% if request.session.total > 249 %}
                        <div class="save">{{ t.delivery_charges|default:'Delivery Charges' }}: <span class="text-success">{{ t.free|default:'Free' }}</span></div>
                    {% else %}
                        <div class="save">{{ t.delivery_charges|default:'Delivery Charges' }}: € 40</div>
                    {% endif %}
                    <div class="total mt-3">
                        <div class="total-amount">{{ t.total|default:'Total' }}: € {{ request.session.total }}</div>
                    </div>
                    <a href="/payments" class="btn button mt-3">{{ t.checkout|default:'Checkout' }}</a>
                    <div class="mt-3 small text-muted">{{ t.stripe_info|default:'We use Stripe Checkout for secure payments.' }}</div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    <br>
</body>
{%endblock%}